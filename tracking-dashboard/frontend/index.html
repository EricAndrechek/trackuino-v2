<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Balloon Tracking Map</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00274c">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">

    <script src="/main.js"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <link rel="stylesheet" href="/styles.css">

    <script src="https://unpkg.com/mqtt@5.5.1/dist/mqtt.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div style="display: none" id="selector1">
        <select id="style-selector1" class="mapboxgl-ctrl mapboxgl-ctrl-group">
            <option value="mapbox://styles/mapbox/standard">Standard Map</option>
            <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
            <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
            <option value="mapbox://styles/mapbox/light-v11">Light</option>
            <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
            <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
        </select>
        <div id="source-selector1" class="mapboxgl-ctrl mapboxgl-ctrl-group">
        </div>
    </div>
    <div id="notification"></div>
    <div id="popup-page">
        <img id="close" onclick="closePopupPage()" src="/assets/x-mark.svg" alt="Close">
    </div>
    <script>        
        onload = () => {
            mapboxgl.accessToken =
                "pk.eyJ1IjoiZXJpY2FuZHIiLCJhIjoiY2x1cnp3Z2tpMDcybTJycGVwN2czNTk3OCJ9.Ccv9oGIfUewgj2Iw-CqOyw";

            var map = new mapboxgl.Map({
                accessToken: mapboxgl.accessToken,
                container: "map",
                attributionControl: false,
                style: "mapbox://styles/mapbox/standard",
                center: [-83.710993, 42.294517],
                zoom: 9,
            });

            let styleChange = false;

            const addSourceSelector = (name) => {
                // check if source selector exists
                if (document.getElementById("source-selector-holder")) {
                    // check if source already exists
                    if (document.getElementById(name + "-checkbox")) {
                        return;
                    } else {
                        // add source selector checkbox
                        const source_selector = document.getElementById("source-selector-holder");

                        // create div to hold checkbox and label
                        const holder = document.createElement("div");
                        // set order to stringified value of getOrder(name)
                        const order = getOrder(name);
                        holder.style.order = order;


                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.id = name + "-checkbox";
                        checkbox.checked = true;
                        checkbox.onchange = () => {
                            if (checkbox.checked) {
                                map.setLayoutProperty(name, 'visibility', 'visible');
                                map.setLayoutProperty(name + "-line", 'visibility', 'visible');
                                map.setLayoutProperty(name + "-line-coordinates", 'visibility', 'visible');
                            } else {
                                map.setLayoutProperty(name, 'visibility', 'none');
                                map.setLayoutProperty(name + "-line", 'visibility', 'none');
                                map.setLayoutProperty(name + "-line-coordinates", 'visibility', 'none');
                            }
                        }
                        const label = document.createElement("label");
                        label.htmlFor = name + "-checkbox";
                        label.style.marginLeft = "5px";
                        label.style.lineHeight = "20px";
                        label.appendChild(document.createTextNode(name));

                        // add map-pin icon to div - when clicked on, center map on source
                        const map_pin = document.createElement("img");
                        map_pin.src = "/assets/map-pin.svg";
                        map_pin.alt = "Center Map";
                        map_pin.style.height = "20px";
                        map_pin.style.cursor = "pointer";
                        map_pin.style.marginLeft = "5px";
                        map_pin.onclick = () => {
                            const source = map.getSource(name);
                            if (source) {
                                const coordinates = source._data.geometry.coordinates;
                                map.flyTo({
                                    center: coordinates,
                                    zoom: 15,
                                });
                            }
                        }

                        holder.appendChild(checkbox);
                        holder.appendChild(label);
                        holder.appendChild(map_pin);

                        source_selector.appendChild(holder);
                    }
                }
            }

            const loopHandler = () => {
                // loop to update map with new data
                if (styleChange) {
                    styleChange = false;
                    return;
                }

                // get tracks and update map with all tracks and their linestrings
                for (const name in positions) {
                    if (name === "undefined") {
                        continue;
                    }
                    const position = positions[name];
                    if (!position || !position.name || position.name === "undefined" || position.name == undefined) {
                        console.log('Invalid position', position)
                        continue;
                    }
                    // check if source already exists
                    if (map.getSource(name)) {
                        // check when the source was last updated
                        const last_update = new Date(position.last_update);
                        const now = new Date();
                        const diff = now - last_update;
                        // if the source was last updated more than 180 minutes ago, remove it
                        if (diff > 180 * 60 * 1000 || (position.current.latitude === 0 && position.current.longitude === 0)) {
                            console.log('Removing source', name)
                            map.removeLayer(name);
                            map.removeSource(name);
                            map.removeLayer(name + "-line-coordinates");
                            map.removeLayer(name + "-line");
                            map.removeSource(name + "-line");

                            // remove checkbox
                            const checkbox = document.getElementById(name + "-checkbox");
                            if (checkbox) {
                                checkbox.parentElement.remove();
                            }

                            // also remove the position from the positions object
                            delete positions[name];
                            // and from telemetry object if it exists
                            if (telemetry[name]) {
                                delete telemetry[name];
                            }
                            continue;
                        }

                        // update source with new data
                        map.getSource(name).setData({
                            type: "Feature",
                            properties: {
                                name: position.name,
                                symbol: position.symbol,
                                altitude: position.current.altitude,
                                speed: position.current.speed,
                                heading: position.current.course,
                                last_update: position.current.datetime,
                            },
                            geometry: {
                                type: "Point",
                                coordinates: [position.current.longitude, position.current.latitude, position.current.altitude]
                            },
                        });
                        map.getSource(name + "-line").setData(getHistoricalGeoJSON(name));

                        // make sure source selector is added
                        addSourceSelector(name);

                    } else {
                        // create a new GeoJSON source and add it to the map
                        const geojson = {
                            type: "Feature",
                            properties: {
                                name: position.name,
                                symbol: position.symbol,
                                altitude: position.current.altitude,
                                speed: position.current.speed,
                                heading: position.current.course,
                                last_update: position.current.datetime,
                            },
                            geometry: {
                                type: "Point",
                                coordinates: [position.current.longitude,position.current.latitude, position.current.altitude]
                            },
                        };

                        map.addSource(name, {
                            type: "geojson",
                            data: geojson,
                        });
                        map.addLayer({
                            id: name,
                            source: name,
                            type: 'symbol',
                            layout: {
                                'icon-image': ['get', 'symbol'],
                                'icon-allow-overlap': true,
                                'icon-size': 0.1,
                                'icon-pitch-alignment': 'viewport',
                                'icon-rotate': ['get', 'heading'],
                                'icon-rotation-alignment': 'map',
                                'symbol-placement': 'point',
                                'symbol-z-elevate': true,
                                'text-field': ['get', 'name'],
                                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                                'text-size': 12,
                                'text-offset': [0, 1.5],
                                'text-anchor': 'top',
                                'text-allow-overlap': false,
                                'text-ignore-placement': true,
                                'text-justify': 'center',

                            },
                            paint: {
                                'icon-color': nameToColor(name),
                            }
                        });

                        map.addSource(name + "-line", {
                            type: "geojson",
                            data: getHistoricalGeoJSON(name),
                        });

                        // draw line, and add point for each coordinate
                        map.addLayer({
                            id: name + "-line",
                            type: "line",
                            source: name + "-line",
                            layout: {
                                "line-join": "round",
                                "line-cap": "round",
                            },
                            paint: {
                                "line-color": nameToColor(name),
                                "line-width": 2,
                            },
                        });
                        // and coordinates
                        map.addLayer({
                            id: name + "-line-coordinates",
                            type: "circle",
                            source: name + "-line",
                            paint: {
                                "circle-radius": 5,
                                "circle-color": nameToColor(name),
                            },
                        });

                        addSourceSelector(name);

                    }
                }
                setTimeout(loopHandler, 100);
            }

            const getCustomImages = async (callback) => {
                // load svgs
                const response = await fetch("/svgs.json");
                const svgs = await response.json();
                console.log('Loaded svgs', svgs);
                for (const svg of svgs) {
                    console.log('Loading image', svg);
                    map.loadImage(svg.url, (error, image) => {
                        if (error) {
                            console.error('Error loading image: ', svg, ' with error: ', error);
                            return;
                        }
                        map.addImage(svg.name, image, { sdf: true });
                    });
                    // load flipped image if it exists
                    if (!svg.url2) {
                        // make image with flip url the same as the original
                        svg.url2 = svg.url;
                    }
                    map.loadImage(svg.url2, (error, image) => {
                        if (error) {
                            console.error('Error loading image', error);
                            return;
                        }
                        map.addImage(svg.name + "-flip", image, { sdf: true });
                    });
                }
                callback();
            }

            map.on('style.load', () => {
                console.log('Style loaded');
                getCustomImages(
                    () => {
                        // delay 1 seconds to allow map to load for sure before adding data
                        setTimeout(() => {
                            console.log('Map loaded');
                            // get class mapboxgl-ctrl-attrib-inner
                            let attrib = document.getElementsByClassName(
                                "mapboxgl-ctrl-attrib-inner"
                            )[0];
                            // edit innerHTML of attrib
                            attrib.innerHTML =
                                "UMich Balloon Map | Made by <a href='https://github.com/EricAndrechek'>Eric</a>";

                            console.log('Adding data');
                            loopHandler();
                        }, 1000);
                    }
                );
            });


            const geolocate = new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true,
                },
                // When active the map will receive updates to the device's location as it changes.
                trackUserLocation: true,
                // Draw an arrow next to the location dot to indicate which direction the device is heading.
                showUserHeading: true,
            })

            map.addControl(geolocate);
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.AttributionControl(
                {
                    compact: true,
                    customAttribution: "UMich Balloon Tracking Map | <a href='https://github.com/EricAndrechek' target='_blank'>Made by Eric</a>"
                }
            ));
            map.addControl(new mapboxgl.ScaleControl());

            map.on("load", async () => {
                // start geolocate right away
                geolocate.trigger();

                // wait 1 second to allow map to load before adding data
                setTimeout(() => {
                    // get class mapboxgl-ctrl-top-left
                    let top_left = document.getElementsByClassName(
                        "mapboxgl-ctrl-top-left"
                    )[0];
                    // copy clone of layer-selector1 to top_left
                    let selector = document.getElementById("selector1").cloneNode(true);
                    // change id of selector to layer-selector
                    selector.id = "selector";
                    // change style-selector1 to style-selector
                    selector.children[0].id = "style-selector";
                    // change source-selector1 to source-selector
                    selector.children[1].id = "source-selector";
                    // add selector to top_left
                    top_left.appendChild(selector);
                    // show selector
                    selector.style.display = "block";

                    // When a new style is selected, update the map style
                    document
                        .getElementById("style-selector")
                        .addEventListener("change", function (e) {
                            styleChange = true;
                            map.setStyle(e.target.value);
                        });
                    
                    // list to each checkbox in source-selector
                    const source_selector = document.getElementById("source-selector");

                    // get class mapboxgl-ctrl-top-right
                    let top_right = document.getElementsByClassName(
                        "mapboxgl-ctrl-top-right"
                    )[0];
                    // create new div
                    let new_div = document.createElement("div");
                    // set class of new div
                    new_div.className = "mapboxgl-ctrl mapboxgl-ctrl-group";
                    // add div to new_div
                    new_div.innerHTML = `
                        <button class="mapboxgl-ctrl-icon" aria-label="Settings"  style="padding: 2px;" onclick="settings()">
                            <img src="/assets/settings.svg" alt="Settings">
                        </button>
                    `;
                    // add new_div to top_right
                    top_right.appendChild(new_div);

                    // add source selector title to source selector
                    const source_selector_title = document.createElement("div");
                    source_selector_title.classList.add("source-selector-title");

                    const source_selector_title_content = document.createElement("h3");
                    source_selector_title_content.innerHTML = "Sources";
                    source_selector_title_content.classList.add("source-title");
                    source_selector_title.appendChild(source_selector_title_content);
                    
                    // add dropdown arrow to source selector
                    const dropdown_arrow = document.createElement("img");
                    dropdown_arrow.src = "/assets/chevron-down.svg";
                    dropdown_arrow.alt = "Dropdown Arrow";
                    dropdown_arrow.classList.add("dropdown-arrow");
                    source_selector_title.appendChild(dropdown_arrow);

                    // create source selector holder for checkboxes
                    const source_selector_holder = document.createElement("div");
                    source_selector_holder.id = "source-selector-holder";
                    source_selector_holder.style.display = "flex";

                    // if source selector is clicked, toggle visibility of source selector
                    source_selector_title.onclick = () => {
                        // change dropdown arrow to point up or down
                        if (source_selector_holder.style.display === "none") {
                            dropdown_arrow.style.transform = "rotate(180deg)";
                        } else {
                            dropdown_arrow.style.transform = "rotate(0deg)";
                        }
                        // toggle visibility of source selector
                        source_selector_holder.style.display = source_selector_holder.style.display === "none" ? "flex" : "none";
                    }

                    source_selector.appendChild(source_selector_title);
                    source_selector.appendChild(source_selector_holder);

                    console.log("added source selector");
                }, 1000);
            });

            geolocate.on('error', () => {
                console.log('GeoLocation error');
            });

            map.on('error', (e) => {
                console.log('Map error', e);
            });

            const call_symbol_popup = (feature) => {
                const coordinates = feature.geometry.coordinates.slice();
                const name = feature.properties.name;
                const altitude = feature.properties.altitude;
                const speed = feature.properties.speed;
                const heading = feature.properties.heading;
                const last_update = feature.properties.last_update;

                let popup_data = `<h3>${name}</h3>`;
                // add coordinates to 6 decimal places
                popup_data += `<p>Coordinates: ${coordinates[1].toFixed(6)}, ${coordinates[0].toFixed(6)}</p>`;
                if (altitude) {
                    popup_data += `<p>Altitude: ${altitudeConversion(altitude)}</p>`;
                }
                if (speed) {
                    popup_data += `<p>Speed: ${speedConversion(speed)}</p>`;
                }
                if (heading) {
                    popup_data += `<p>Heading: ${heading.toFixed(2)}°</p>`;
                }
                if (last_update && last_update !== "undefined" && last_update !== "null" && last_update !== "None" && last_update !== "null" && last_update !== "None" && last_update !== "undefined" && last_update !== "" && last_update !== "Invalid Date") {
                    popup_data += `<p>Last Update: ${last_update}</p>`;
                }

                // add telemetry data if it exists
                if (telemetry[name]) {
                    const telemetry_data = telemetry[name];
                    for (const key in telemetry_data) {
                        if (key === "undefined") {
                            continue;
                        }
                        const value = telemetry_data[key];
                        if (value === "undefined" || value === undefined || value === null || value === "null" || value === "None" || value === "none" || value === "") {
                            continue;
                        }
                        popup_data += `<p>${key}: ${value}</p>`;
                    }
                }

                // show popup-page
                const popup_page = document.getElementById("popup-page");
                // clear innerHTML of popup-page
                popup_page.innerHTML = "";
                // create div to hold popup data
                const popup_div = document.createElement("div");
                popup_div.classList.add("popup-div");
                popup_div.innerHTML = popup_data;

                // add popup_div to popup_page
                popup_page.appendChild(popup_div);
                // show popup_page
                popup_page.classList.add("page-show");
            }

            const call_circle_popup = (feature, closest) => {
                // first 2 elements of closest are lng, lat
                const coordinates = closest.slice(0, 2);
                const name = feature.properties.name;

                let popup_data = `<h3>${name}</h3>`;
                // add coordinates to 6 decimal places
                popup_data += `<p>Coordinates: ${coordinates[1].toFixed(6)}, ${coordinates[0].toFixed(6)}</p>`;

                // this data should be in the geojson object
                if (closest.length !== 7) {
                    console.error('Point missing data: ', closest);
                } else {
                    const altitude = closest[2];
                    const speed = closest[3];
                    const heading = closest[4];
                    const comment = closest[5];
                    const last_update = closest[6];

                    // set popup with data (only data that is not undefined, none, null, "", etc)
                    
                    if (altitude) {
                        popup_data += `<p>Altitude: ${altitudeConversion(altitude)}</p>`;
                    }
                    if (speed) {
                        popup_data += `<p>Speed: ${speedConversion(speed)}</p>`;
                    }
                    if (heading) {
                        popup_data += `<p>Heading: ${heading.toFixed(2)}°</p>`;
                    }
                    if (comment) {
                        popup_data += `<p>Comment: ${comment}</p>`;
                    }
                    if (last_update && last_update !== "undefined" && last_update !== "null" && last_update !== "None" && last_update !== "null" && last_update !== "None" && last_update !== "undefined" && last_update !== "" && last_update !== "Invalid Date") {
                        popup_data += `<p>Data Timestamp: ${last_update}</p>`;
                    }
                }

                const popup = new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(popup_data)
                    .addTo(map);
            }

            map.on('click', (e) => {
                // should be able to click on a symbol (car or balloon) and pop-open a popup with more information
                // or click on a circle on the line and pop-open a popup with more information

                // if popup-page is open, close it
                const popup_page = document.getElementById("popup-page");
                if (popup_page.classList.contains("page-show")) {
                    popup_page.classList.remove("page-show");
                }

                // get features at the point that were created by us
                let features = [];
                try {
                    features = map.queryRenderedFeatures(e.point);
                } catch (error) {
                    // ignore RangeError
                    if (error instanceof RangeError) {
                        return;
                    }
                    console.error('Error querying rendered features', error);
                }

                if (features.length === 0) {
                    return;
                }

                // get first "symbol" in layer.type
                let feature = features.find((feature) => feature.layer.type === "symbol");
                // if no symbol, get first "circle" in layer.type
                if (!feature) {
                    feature = features.find((feature) => feature.layer.type === "circle");
                }
                if (!feature) {
                    return;
                }

                // if its a symbol, call popup with more information
                if (feature.layer.type === "symbol") {
                    call_symbol_popup(feature);
                } else if (feature.layer.type === "circle") {
                    // use turf nearestPointOnLine to get closest point on line to clicked coords
                    const line = map.getSource(feature.source)._data;
                    const closest = turf.nearestPointOnLine(line, e.lngLat.toArray());
                    // find coordinate index in line smallest distance away from closest point
                    lowest_distance = Number.MAX_VALUE;
                    closest_index = 0;
                    for (let i = 0; i < line.geometry.coordinates.length; i++) {
                        const distance = turf.distance(turf.point(line.geometry.coordinates[i]), closest);
                        if (distance < lowest_distance) {
                            lowest_distance = distance;
                            closest_index = i;
                        }
                    }
                    // call popup with more information
                    call_circle_popup(feature, line.geometry.coordinates[closest_index]);
                }
            });
        };
    </script>
    <script src="/mqtt.js"></script>
    <script>
        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then(() => console.log('Service Worker registered successfully.'))
            .catch(error => console.error('Service Worker registration failed:', error));
        }
    </script>
</body>
</html>
