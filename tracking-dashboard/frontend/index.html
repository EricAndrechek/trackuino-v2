<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balloon Tracking Map</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#00274c">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">

    <script src="/main.js"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="/styles.css">

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div style="display: none" id="layer-selector1" class="mapboxgl-ctrl mapboxgl-ctrl-group">
        <select id="style-selector">
            <option value="mapbox://styles/ericandr/cluvydoes006n01pk7a9z9hwv/draft">Streets</option>
            <option value="mapbox://styles/ericandr/cluvy4r03005g01nrdfgg89ea/draft">Satellite Streets</option>
        </select>
    </div>
    <div id="notification"></div>
    <script>
        onload = () => {
            mapboxgl.accessToken =
                "pk.eyJ1IjoiZXJpY2FuZHIiLCJhIjoiY2x1cnp3Z2tpMDcybTJycGVwN2czNTk3OCJ9.Ccv9oGIfUewgj2Iw-CqOyw";

            var map = new mapboxgl.Map({
                accessToken: mapboxgl.accessToken,
                container: "map",
                attributionControl: false,
                style: "mapbox://styles/ericandr/cluvydoes006n01pk7a9z9hwv/draft",
                center: [-83.710993, 42.294517],
                zoom: 9,
            });

            map.on('style.load', () => {
                // Can't figure out why this isn't working, but it's not a priority
                // console.log('Changing light preset');
                // map.setConfigProperty('basemap', 'lightPreset', 'dusk');

                console.log('Map loaded');
                // delay 2 seconds to allow map to load before adding data
                setTimeout(() => {
                    // get class mapboxgl-ctrl-attrib-inner
                    let attrib = document.getElementsByClassName(
                        "mapboxgl-ctrl-attrib-inner"
                    )[0];
                    // edit innerHTML of attrib
                    attrib.innerHTML =
                        "UMich Balloon Map | Made by <a href='https://github.com/EricAndrechek'>Eric</a>";
                    
                    // get class mapboxgl-ctrl-top-left
                    let top_left = document.getElementsByClassName(
                        "mapboxgl-ctrl-top-left"
                    )[0];
                    // copy layer-selector1 to top_left
                    let layer_selector1 = document.getElementById("layer-selector1");
                    // change id of layer_selector1 to layer-selector
                    layer_selector1.id = "layer-selector";
                    // add layer_selector1 to top_left
                    top_left.appendChild(layer_selector1);
                    // show layer-selector1
                    layer_selector1.style.display = "block";

                    // get class mapboxgl-ctrl-top-right
                    let top_right = document.getElementsByClassName(
                        "mapboxgl-ctrl-top-right"
                    )[0];
                    // create new div
                    let new_div = document.createElement("div");
                    // set class of new div
                    new_div.className = "mapboxgl-ctrl mapboxgl-ctrl-group";
                    // add div to new_div
                    new_div.innerHTML = `
                        <button class="mapboxgl-ctrl-icon" aria-label="Settings"  style="padding: 2px;" onclick="settings()">
                            <img src="/assets/settings.svg" alt="Settings">
                        </button>
                    `;
                    // add new_div to top_right
                    top_right.appendChild(new_div);
                }, 2000);
            });


            const geolocate = new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true,
                },
                // When active the map will receive updates to the device's location as it changes.
                trackUserLocation: true,
                // Draw an arrow next to the location dot to indicate which direction the device is heading.
                showUserHeading: true,
            })

            map.addControl(geolocate);
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.AttributionControl(
                {
                    compact: true,
                    customAttribution: "UMich Balloon Tracking Map | <a href='https://github.com/EricAndrechek' target='_blank'>Made by Eric</a>"
                }
            ));
            map.addControl(new mapboxgl.ScaleControl());

            // When a new style is selected, update the map style
            document
                .getElementById("style-selector")
                .addEventListener("change", function (e) {
                    map.setStyle(e.target.value);
                });

            map.on("load", async () => {
                geolocate.trigger();

                // load svgs
                const response = await fetch("/svgs.json");
                const svgs = await response.json();
                console.log('Loaded svgs', svgs);
                for (const svg of svgs) {
                    console.log('Loading image', svg);
                    map.loadImage(svg.url, (error, image) => {
                        if (error) {
                            console.error('Error loading image: ', svg, ' with error: ', error);
                            return;
                        }
                        map.addImage(svg.name, image, { sdf: true });
                    });
                    // load flipped image if it exists
                    if (!svg.url2) {
                        // make image with flip url the same as the original
                        svg.url2 = svg.url;
                    }
                    map.loadImage(svg.url2, (error, image) => {
                        if (error) {
                            console.error('Error loading image', error);
                            return;
                        }
                        map.addImage(svg.name + "-flip", image, { sdf: true });
                    });
                }

                // loop to update map with new data
                const timer = setInterval(() => {

                    // get tracks and update map with all tracks and their linestrings
                    for (const name in positions) {
                        if (name === "undefined") {
                            continue;
                        }
                        const position = positions[name];
                        if (!position || !position.name || position.name === "undefined" || position.name == undefined) {
                            console.log('Invalid position', position)
                            continue;
                        }
                        // check if source already exists
                        if (map.getSource(name)) {
                            // check when the source was last updated
                            const last_update = new Date(position.last_update);
                            const now = new Date();
                            const diff = now - last_update;
                            // if the source was last updated more than 180 minutes ago, remove it
                            if (diff > 180 * 60 * 1000 || (position.current.latitude === 0 && position.current.longitude === 0)) {
                                console.log('Removing source', name)
                                map.removeLayer(name);
                                map.removeSource(name);
                                map.removeLayer(name + "-line");
                                map.removeSource(name + "-line");

                                // also remove the position from the positions object
                                delete positions[name];
                                // and from telemetry object if it exists
                                if (telemetry[name]) {
                                    delete telemetry[name];
                                }
                                continue;
                            }

                            // update source with new data
                            map.getSource(name).setData({
                                type: "Feature",
                                properties: {
                                    name: position.name,
                                    symbol: position.symbol,
                                    altitude: position.current.altitude,
                                    speed: position.current.speed,
                                    heading: position.current.course,
                                    last_update: position.current.datetime,
                                },
                                geometry: {
                                    type: "Point",
                                    coordinates: [position.current.longitude, position.current.latitude, position.current.altitude]
                                },
                            });
                            map.getSource(name + "-line").setData(getHistoricalGeoJSON(name));
                        } else {
                            // create a new GeoJSON source and add it to the map
                            const geojson = {
                                type: "Feature",
                                properties: {
                                    name: position.name,
                                    symbol: position.symbol,
                                    altitude: position.current.altitude,
                                    speed: position.current.speed,
                                    heading: position.current.course,
                                    last_update: position.current.last_update,
                                },
                                geometry: {
                                    type: "Point",
                                    coordinates: [position.current.longitude,position.current.latitude, position.current.altitude]
                                },
                            };
                            console.log('Adding new source', name, geojson, getHistoricalGeoJSON(name));
                            map.addSource(name, {
                                type: "geojson",
                                data: geojson,
                            });
                            map.addLayer({
                                id: name,
                                source: name,
                                type: 'symbol',
                                layout: {
                                    'icon-image': ['get', 'symbol'],
                                    'icon-allow-overlap': true,
                                    'icon-size': 0.1,
                                    'icon-rotate': ['get', 'heading'],
                                    'icon-rotation-alignment': 'map',
                                    'symbol-placement': 'point',
                                    'symbol-z-elevate': true
                                },
                                paint: {
                                    'icon-color': nameToColor(name),
                                }
                            });

                            map.addSource(name + "-line", {
                                type: "geojson",
                                data: getHistoricalGeoJSON(name),
                            });

                            map.addLayer({
                                id: name + "-line",
                                source: name + "-line",
                                type: "line",
                                layout: {
                                    "line-join": "round",
                                    "line-cap": "round"
                                },
                                paint: {
                                    "line-color": nameToColor(name),
                                    "line-width": 4,
                                },
                            });
                        }
                    }
                }, 100);
            });

            geolocate.on('error', () => {
                console.log('GeoLocation error');
            });

            map.on('error', (e) => {
                console.log('Map error', e);
            });

            map.on('click', (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: Object.keys(positions)
                });
                if (!features.length) {
                    return;
                }

                const feature = features[0];
                const coordinates = feature.geometry.coordinates.slice();
                const name = feature.properties.name;
                const altitude = feature.properties.altitude;
                const speed = feature.properties.speed;
                const heading = feature.properties.heading;
                // time since last update to now in human readable format
                const last_update = new Date(feature.properties.last_update).toLocaleString();

                // fly to the point
                let current_zoom = map.getZoom();
                if (current_zoom < 10) {
                    current_zoom = 10;
                }
                map.flyTo({
                    center: coordinates,
                    zoom: current_zoom,
                });

                const popup = new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(
                        `<h3>${name}</h3>
                        <p>Altitude: ${altitude} m</p>
                        <p>Speed: ${speed} m/s</p>
                        <p>Heading: ${heading}Â°</p>
                        <p>Last Updated: ${last_update}</p>`
                    )
                    .addTo(map);
            });
        };
    </script>
    <script src="/mqtt.js"></script>
    <script>
        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then(() => console.log('Service Worker registered successfully.'))
            .catch(error => console.error('Service Worker registration failed:', error));
        }
    </script>
</body>
</html>
