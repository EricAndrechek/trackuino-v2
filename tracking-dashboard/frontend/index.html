<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balloon Tracking Map</title>
    <link rel="manifest" href="/manifest.json">

    <script src="/main.js"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="/styles.css">

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div class="map-overlay" id="layer-selector">
        <select id="style-selector">
            <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
            <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
            <option value="mapbox://styles/mapbox/light-v11">Light</option>
            <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
            <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
            <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
        </select>
    </div>
    <div id="notification"></div>
    <script>
        onload = () => {
            mapboxgl.accessToken =
                "pk.eyJ1IjoiZXJpY2FuZHIiLCJhIjoiY2x1cnp3Z2tpMDcybTJycGVwN2czNTk3OCJ9.Ccv9oGIfUewgj2Iw-CqOyw";

            var map = new mapboxgl.Map({
                container: "map",
                style: "mapbox://styles/mapbox/streets-v12",
                sprite: "https://example.com/sprite",
                center: [-83.710993, 42.294517],
                zoom: 13,
            });

            const geolocate = new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true,
                },
                // When active the map will receive updates to the device's location as it changes.
                trackUserLocation: true,
                // Draw an arrow next to the location dot to indicate which direction the device is heading.
                showUserHeading: true,
            })

            map.addControl(geolocate);

            // When a new style is selected, update the map style
            document
                .getElementById("style-selector")
                .addEventListener("change", function (e) {
                    map.setStyle(e.target.value);
                });

            map.on("load", async () => {
                geolocate.trigger();

                

                // loop to update map with new data
                const timer = setInterval(() => {
                    // get tracks and update map with all tracks and their linestrings
                    for (const name in positions) {
                        if (name === "undefined") {
                            continue;
                        }
                        const position = positions[name];
                        if (!position || !position.name || position.name === "undefined" || position.name == undefined) {
                            console.log('Invalid position', position)
                            continue;
                        }
                        // check if source already exists
                        if (map.getSource(name)) {
                            // update source with new data
                            map.getSource(name).setData({
                                type: "Feature",
                                properties: {
                                    name: position.name,
                                    symbol: position.symbol,
                                    altitude: position.current.altitude,
                                    speed: position.current.speed,
                                    heading: position.current.heading,
                                    last_update: position.current.last_update,
                                },
                                geometry: {
                                    type: "Point",
                                    coordinates: [position.current.latitude, position.current.longitude, position.current.altitude]
                                },
                            });
                            map.getSource(name + "-line").setData(getHistoricalGeoJSON(name));
                        } else {
                            // create a new GeoJSON source and add it to the map
                            const geojson = {
                                type: "Feature",
                                properties: {
                                    name: position.name,
                                    symbol: position.symbol,
                                    altitude: position.current.altitude,
                                    speed: position.current.speed,
                                    heading: position.current.heading,
                                    last_update: position.current.last_update,
                                },
                                geometry: {
                                    type: "Point",
                                    coordinates: [position.current.latitude, position.current.longitude, position.current.altitude]
                                },
                            };
                            console.log('Adding new source', name, geojson)
                            map.addSource(name, {
                                type: "geojson",
                                data: geojson,
                            });
                            map.addLayer({
                                id: name,
                                source: name,
                                type: 'symbol',
                                layout: {
                                    'icon-image': ['get', 'symbol'],
                                    'icon-allow-overlap': true,
                                    'icon-size': 2,
                                },
                            });

                            map.addSource(name + "-line", {
                                type: "geojson",
                                data: getHistoricalGeoJSON(name),
                            });

                            map.addLayer({
                                id: name + "-line",
                                source: name + "-line",
                                type: "line",
                                paint: {
                                    "line-color": "#888",
                                    "line-width": 4,
                                },
                            });
                        }
                    }
                }, 100);
            });
            geolocate.on('error', () => {
                console.log('GeoLocation error');
            });
        };
    </script>
    <script src="/mqtt.js"></script>
    <script>
        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then(() => console.log('Service Worker registered successfully.'))
            .catch(error => console.error('Service Worker registration failed:', error));
        }
    </script>
</body>
</html>
